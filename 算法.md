这段代码实现了一个基于**时空共振交易系统（Time-Space Resonance Trading System）** 的股票评分模型，核心功能是通过多维度分析股票的技术面特征，并结合不同市场（如美股、港股）的特性调整评分规则，最终输出一个0-100分的综合评分，用于判断股票的投资价值。


### 代码核心逻辑拆解

#### 1. 基础数据准备
- 从股票数据（`df`，通常是包含价格、指标的DataFrame）中提取最新数据（`latest = df.iloc[-1]`）。
- 限定分析周期为最近30天（或数据不足时取全部可用数据）。


#### 2. 评分维度与权重设计
模型通过5个核心维度对股票评分，并根据市场类型动态调整权重：

| 评分维度         | 基础权重 | 美股（US）调整后 | 港股（HK）调整后 | 核心分析目标                     |
|------------------|----------|------------------|------------------|----------------------------------|
| 趋势（trend）    | 30%      | 35%              | 30%              | 均线排列、价格与均线位置关系     |
| 波动率（volatility） | 15%   | 10%              | 20%              | 价格波动幅度是否合理             |
| 技术指标（technical） | 25%  | 25%              | 25%              | RSI、MACD、布林带等信号          |
| 成交量（volume） | 20%      | 20%              | 25%              | 量价配合关系（量能是否健康）     |
| 动量（momentum） | 10%      | 15%              | 10%              | 价格上涨/下跌的动力强弱          |

- **权重调整逻辑**：美股更看重长期趋势和动量，港股更关注波动率和成交量（因港股波动较大，且受资金流动影响明显）。


#### 3. 各维度评分细则

##### （1）趋势评分（最高30分）
基于均线系统判断趋势方向：
- **均线排列**：5日、20日、60日均线呈多头排列（MA5>MA20>MA60）得15分；短期（MA5>MA20）得10分；中期（MA20>MA60）得5分。
- **价格位置**：收盘价在5日、20日、60日均线上方，分别各得5分（共15分）。
- 总分不超过30分。


##### （2）波动率评分（最高15分）
衡量价格波动是否处于合理区间（波动过小缺乏活力，过大则风险高）：
- 波动率在1.0-2.5之间（最优）：15分；
- 2.5-4.0之间（较高但可接受）：10分；
- <1.0（过低）：5分；
- >4.0（过高风险）：0分。


##### （3）技术指标评分（最高25分）
综合RSI、MACD、布林带三大指标：
- **RSI（10分）**：
    - 30-40或60-70（阈值区，潜在反转信号）：10分；
    - <30（超卖，潜在买入机会）：8分；
    - 40-60（中性）：7分；
    - >70（超买，潜在卖出风险）：2分。
- **MACD（10分）**：
    - 金叉且柱状体为正：10分；
    - 仅金叉：8分；
    - 柱状体扩大（潜在反转）：5分；
    - 死叉且柱状体为负：0分。
- **布林带（5分）**：
    - 价格在布林带中轨附近（0.3-0.7区间）：3分；
    - 靠近下轨（超卖）：5分；
    - 靠近上轨（超买）：1分。


##### （4）成交量评分（最高20分）
通过量价关系判断资金动能（量能守恒维度）：
- 近5日平均量比>1.5且价格上涨（量价齐升，动能强）：20分；
- 量比>1.2且价格上涨：15分；
- 量比<0.8且价格下跌（缩量调整，健康）：10分；
- 量比>1.2但价格下跌（放量下跌，抛压大）：0分；
- 其他情况：8分。


##### （5）动量评分（最高10分）
通过ROC指标判断价格趋势强度：
- ROC>5（强上涨动量）：10分；
- 2-5（中等上涨）：8分；
- 0-2（弱上涨）：5分；
- -2-0（弱下跌）：3分；
- < -2（强下跌）：0分。


#### 4. 综合评分计算
- 先按各维度得分和对应权重计算原始总分（公式中通过除以基础权重实现标准化，确保不同权重下总分范围一致）。
- 结合市场类型进行特殊调整：
    - **美股**：若处于财报季，评分向均值回归（0.9×原始分+5），因财报季波动大，降低极端评分影响。
    - **港股**：若与A股联动性高（>70%），则结合A股市场情绪调整（情绪好+5分，差-5分）。
- 最终得分限制在0-100分之间。


#### 5. 结果存储
将各维度得分和总分存入`score_details`，便于后续查看评分明细。


### 核心特点
- **多维度共振**：综合趋势、波动率、技术指标、量能、动量，避免单一指标的局限性。
- **市场适应性**：针对美股、港股的不同特性调整权重和规则（如美股重趋势、港股重量能）。
- **动态校准**：通过特殊市场事件（如财报季）和联动性（如港股与A股）调整评分，增强实用性。

该模型本质是一个技术面驱动的量化评分工具，可辅助筛选符合特定技术特征的股票，但实际投资需结合基本面和风险控制。